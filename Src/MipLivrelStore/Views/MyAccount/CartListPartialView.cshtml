@using DDD.Application.ViewModels;
@inject IStringLocalizer<SharedResource> SharedLocalizer
@using Microsoft.AspNetCore.Localization
@model List<CartViewModel>
<style>
.btn-xl {
	padding: 10px 20px;
	font-size: 20px;
	border-radius: 10px;
}
.card {
  flex-direction: row;
		height: fit-content;
}
.card img {
			width: 50px;
			height: 50px;
			border-right: 1px solid rgba(0, 0, 0, 0.125);
}

	.card-body{
		padding-bottom:0;
		padding-top:0;
	}
</style>
@{
	var requestCulture = Context.Features.Get<IRequestCultureFeature>();
	var selectedCulture = requestCulture.RequestCulture.Culture;

}

@{
	//var user = await UserManager.GetUserAsync(User);
	//var userId = user?.Id;
	//var CartItems = _CartService.GetCartsByUserId(userId).ToList();
	var total = 0.0;
	<!-- Title -->
	<header class="border-bottom pl-2 pb-4 ml-0" style="padding-top: 1.8rem;">
		<h2 class="font-size-3 mb-0">
			<label class="entry-title font-size-3">
				<i class="flaticon-icon-126515 mr-2 font-size-5"></i>
				@SharedLocalizer["Cart.YourCart"] (<label id="CartCountId" class="entry-title font-size-3">@Model.Count</label>)
			</label>
		</h2>
	</header>
	<!-- End Title -->
	@if (Model.Count == 0)
	{
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-md-12 text-center">
					<img src="~/Template/Image/NoResultFound.png" class="resultNotFound" alt="No Result Found" />
					<div class="mb-4 lead">@SharedLocalizer["SearchResult.NoResultFound"]</div>
					<p>@SharedLocalizer["SearchResult.NoResultFoundText"].</p>
				</div>
			</div>
		</div>

	}
	else
	{
		@foreach (var item in Model)
		{
			@if (item.CartVM.Book.PromotionsPercentage != 0 && item.CartVM.Book.PromotionsPercentage != 100)
			{
				total += item.CartVM.Book.BusinessPrice - (item.CartVM.Book.BusinessPrice * item.CartVM.Book.PromotionsPercentage / 100);
			}
			else
			{
				total += item.CartVM.Book.BusinessPrice;
			}

			<div class="px-4 py-5 @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4") border-bottom">
				<div class="media">
					<a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")" class="d-block">
						<img src="@($"https://miplivrelstorage.blob.core.windows.net/bookscover/{@item.CartVM.Book.CoverPath}")" class="img-fluid" alt="image-description" style="height:180px;width:120px">
					</a>
					<div class="media-body @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4") ">
						@*<div class="text-primary text-uppercase font-size-1 mb-1 text-truncate"><a href="#"> xx</a></div>*@
						<h2 class="woocommerce-loop-product__title h6 text-lh-md mb-1 text-height-2 crop-text-2">
							<a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")" class="text-dark">@item.CartVM.Book.Title</a>
						</h2>
						<div class="font-size-2 mb-1 text-truncate"><a href="#" class="text-gray-700">@item.CartVM.Book.AuthorName</a></div>
						<div class="price d-flex align-items-center font-weight-medium font-size-3">
							<span class="woocommerce-Price-amount amount">
								<span class="woocommerce-Price-currencySymbol"></span>
								@if (item.CartVM.Book.PromotionsPercentage != 0 && item.CartVM.Book.PromotionsPercentage != 100)
								{
									@(item.CartVM.Book.BusinessPrice - (item.CartVM.Book.BusinessPrice * item.CartVM.Book.PromotionsPercentage / 100))
								}
								else
								{
									@item.CartVM.Book.BusinessPrice
								} @SharedLocalizer["Book.Currency"]
							</span>
						</div>
					</div>
					<div class="mt-3 ml-3">
						@if (item.CartVM.Book.PromotionsPercentage != 0 && item.CartVM.Book.PromotionsPercentage != 100)
						{
							<a value="@item.CartVM.Book.Id" data-BookPrice="@(item.CartVM.Book.BusinessPrice - (item.CartVM.Book.BusinessPrice * item.CartVM.Book.PromotionsPercentage / 100))" role="button" title="@SharedLocalizer["Operations.Delete"]" data-toggle="modal" data-target="#zizi" class="deleteRow text-dark arrow-cursor"><i class="fas fa-trash"></i></a>
						}
						else
						{
							<a value="@item.CartVM.Book.Id" data-BookPrice="@item.CartVM.Book.BusinessPrice" role="button" title="@SharedLocalizer["Operations.Delete"]" data-toggle="modal" data-target="#zizi" class="deleteRow text-dark arrow-cursor"><i class="fas fa-trash"></i></a>
						}
					</div>
				</div>
			</div>
		}
		<div id="SubTotalDiv">
			<div class="px-4 py-3 @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4") d-flex justify-content-between align-items-center font-size-3">
				<h1 class="mb-0 font-size-3" style="color:dimgrey">@SharedLocalizer["Cart.SubTotal"] </h1>
				<label id="CartSubTotalId" class="mb-0 font-size-2">@total @SharedLocalizer["Book.Currency"]</label>
			</div>
			<div class="px-4  @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4") d-flex justify-content-between align-items-center font-size-3">
				<h1 class="mb-0 font-size-3" style="color:dimgrey">@SharedLocalizer["Cart.Tax"] </h1>
				<label class="mb-0 font-size-2">1 @SharedLocalizer["Book.Currency"]</label>
			</div>
		</div>
		total++;
		<div class="px-4 py-5 @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4") d-flex justify-content-between align-items-center font-size-3">
			<h4 class="mb-0 font-size-3">@SharedLocalizer["Cart.Total"] :</h4>
			<label id="CartTotalId" class="mb-0 font-size-3">@total @SharedLocalizer["Book.Currency"]</label>
		</div>
	}

}

<div class="px-4 mb-8 @(selectedCulture.Name.Equals("ar") ? "mr-4" : "ml-4")">
	@*<form class="form-inline" asp-controller="MyAccount" asp-action="Index" id="formUserSpace1">
		<button type="button" asp-controller="MyAccount" asp-action="Index" onclick="document.getElementById('formUserSpace1').submit();"  class="btn btn-block py-4 rounded-0 btn-outline-dark mb-4 @(Model.Count == 0 ? "disabled" : "")">@SharedLocalizer["Cart.SeeCart"]</button>

	</form>*@
	<button type="button" onclick="location.href='@Url.Action("Index","MyAccount")'" class="btn btn-block py-4 rounded-0 btn-outline-dark mb-4 @(Model.Count == 0 ? "disabled" : "")">@SharedLocalizer["Cart.SeeCart"]</button>

	<div class="card mb-2" >
			<img src="~/img/paiement/postetn.png" class="card-img-top" alt="...">
		<div class="card-body d-flex justify-content-between align-items-center">
			<p class="card-text">@SharedLocalizer["PaiementType.PostOffice"]</p>
				<button id="Checkout_Post" type="button" class="btn btn-primary btn-sm @(Model.Count==0 ? "disabled" : "")">@SharedLocalizer["Cart.Payment"]</button>
			</div>
		</div>
		<div class="card">
			<img src="~/img/paiement/clic2pay.jpg" class="card-img-top" alt="...">
		<div class="card-body d-flex justify-content-between align-items-center">
			<p class="card-text">@SharedLocalizer["PaiementType.Bank"]</p>
			<button id="CheckoutLink_Sidebar" type="button" class="btn btn-primary btn-sm @(Model.Count==0 ? "disabled" : "")">@SharedLocalizer["Cart.Payment"]</button>
			</div>
		</div>
</div>

<script type="text/javascript">
	$(document).ready(function () {

		var _currentCartLink = "/MyAccount/GetCartListDashboard";

		$('a.deleteRow').click(function () {
			var bookId = $(this).attr("value");
			var _currentDiv = $(this).parent().parent().parent();
			var _OldTotal = $('#CartTotalId')[0].innerHTML.split(" ")[0];
			var _OldSubTotal = $('#CartSubTotalId')[0].innerHTML.split(" ")[0];
			var _OldCount = $('#CartCountId')[0].innerHTML;
			var _bookPrice = $(this).attr("data-BookPrice");

			//debugger
			$.ajax({
				method: "delete",
				url: "/Book/DeleteBookFromCart",
				data: "BookId=" + JSON.stringify(bookId),
				contentType: "application/x-www-form-urlencoded; charset=utf-8",
				dataType: "json",
				async: false,
				success: function () {
					var _NewTotal = parseFloat(_OldTotal) - parseFloat(_bookPrice);
					var _NewSubTotal = parseFloat(_OldSubTotal) - parseFloat(_bookPrice);
					var _NewCount = parseFloat(_OldCount) - 1;

					if (parseFloat(_NewSubTotal) == 0) {
						$("#CartTotalId").empty();
						$("#CartTotalId").append("0 " + '@SharedLocalizer["Book.Currency"]');
						$("#SubTotalDiv").remove();
						$('#Checkout_Post').prop('disabled', true);
						$('#CheckoutLink_Sidebar').prop('disabled', true);
					} else {
						$("#CartTotalId").empty();
						$("#CartTotalId").append(_NewTotal + " " + '@SharedLocalizer["Book.Currency"]');
						$("#CartSubTotalId").empty();
						$("#CartSubTotalId").append(_NewSubTotal + " " + '@SharedLocalizer["Book.Currency"]');
					}
					$("#CartCountId").empty();
					$("#CartCountId").append(_NewCount);
					_currentDiv.remove();
					$("#totalCount").text(_NewCount);
					$("#totalCountMobile").text(_NewCount);
					$("#pills-myaccount-body").load(_currentCartLink);
					//$(".bookGridView").load(location.href + " .bookGridView");
					$(".bookListView").load(location.href + " .bookListView");
					$("#CartLinkId").load(location.href + " #CartLinkId>*", "");

					//$('.sb__' + bookId).load("book/GetSingleBook?bookId=" + bookId);
					$('.sb__' + bookId).each(function () {
						var single = $(this);
						single.load(window.location.origin + "/book/getSingleBook?bookId=" + bookId);
					});
				},
				error: function (response, textStatus) {
					//debugger
					alert(textStatus);
				}
			});
		});

		var result;
		//$("button.btn-outline-dark").click(function (e) {
		//	e.preventDefault();
		//	//_currentCartLink = $(this).attr('formaction');
		//	////debugger
		//	$.ajax({
		//		type: "GET",
		//		url: "/MyAccount/Index",
		//		contentType: "application/json; charset=utf-8",
		//		dataType: "html",
		//		//async: false,
		//		success: function (data) {
		//			result = data;
		//			////debugger
		//			document.open();
		//			document.write(data);
		//			document.close();
		//			//afterSuccess();
		//		},
		//		error: function (response) {
		//			alert(response.responseText);
		//			//debugger
		//		}
		//	}).always(function () {
		//		$("#pills-myaccount-body").load(_currentCartLink);
		//		//debugger
		//	});
		//});

		var afterSuccess = function () {
			var tt = $("#pills-myaccount-body");
			//debugger
			$("#pills-myaccount-body").load(_currentCartLink);
		};
		//$("button.btn-outline-dark").click(function (e) {
		//    //debugger
		//    var ee = $(this).attr('href');
		//    e.preventDefault();
		//    window.location.pathname = '/MyAccount/Index';
		//    //debugger
		//});

		$("#CheckoutLink_Sidebar").click(function (e) {
			e.preventDefault();
            ////debugger
			$.ajax({
				method: "Get",
				url: "@Url.Action("ClickToPayRegister", "MyAccount")",
				success: function (response) {
					//debugger
					//if (JSON.parse(response.data).formUrl)
					//window.open(response.data.url,"_blank");
					window.location.href = response.data.url;
				},
                error: function (jqXhr, textStatus, errorThrown) {
					$(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
						$(".md-toast-error").slideUp(500);
					});
				}
			});
		});
		$("#Checkout_Post").click(function (e) {
			$.ajax({
				method: "Get",
				url: "/MyAccount/MPGSCreateSession",
				success: function (response) {
					//alert(response)
					//alert(response.data)
					//alert(JSON.parse(response))
					//alert(JSON.parse(response)["merchant"])
					//var resp = JSON.parse(response);
					var responseobj = JSON.parse(response["result"]);
					Checkout.configure({
						session: {
							id: responseobj["session"]["id"]
						}
					})
					Checkout.showPaymentPage();
				},
				error: function (jqXhr, textStatus, errorThrown) {
					$(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
						$(".md-toast-error").slideUp(500);
					});
				}
			});
		});
	});
</script>
