@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Localization
@inject IStringLocalizer<SharedResource> SharedLocalizer


@using DDD.Application.ViewModels;
@model List<CartViewModel>
<style>
	.btn-xl {
		padding: 10px 20px;
		font-size: 20px;
		border-radius: 10px;
	}

	.card {
		flex-direction: row;
		height: fit-content;
	}

		.card img {
			width: 50px;
			height: 50px;
			border-right: 1px solid rgba(0, 0, 0, 0.125);
		}

	.card-body {
		padding-bottom: 0;
		padding-top: 0;
	}
</style>
@{
	var requestCulture = Context.Features.Get<IRequestCultureFeature>();
	var selectedCulture = requestCulture.RequestCulture.Culture;
    var total = 0.0;
    <div class="site-content overflow-hidden" id="content">
        <div class="container">
            <header class="entry-header space-top-2 space-bottom-1">
                <label class="entry-title font-size-5">
                    @SharedLocalizer["Cart.YourCart"] (<label id="CartCountId" class="entry-title ">@Model.Count</label>)
                </label>
            </header>
            @if (@Model.Count == 0)
            {
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-md-12 text-center">
                            <img src="~/Template/Image/NoResultFound.png" class="resultNotFound" alt="No Result Found" />
                            <div class="mb-4 lead">@SharedLocalizer["SearchResult.NoResultFound"]</div>
                            <p>@SharedLocalizer["SearchResult.NoResultFoundText"]</p>
							<a asp-controller="MyAccount" asp-action="Index" class="MyAccountGoBack btn btn-dark rounded-0 text-white">@SharedLocalizer["Index.GoBack"]</a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="row pb-8">
                    <div id="primary" class="content-area">
                        <main id="main" class="site-main ">
                            <div class="page type-page status-publish hentry">
                                <!-- .entry-header -->
                                <div class="entry-content">
                                    <div class="woocommerce d-none d-md-flex">
                                        <form class="woocommerce-cart-form table-responsive" action="#" method="post">
                                            <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents">
                                                <thead>
                                                    <tr>
                                                        <th class="product-name">@SharedLocalizer["Navbar.Books"]</th>
                                                        <th class="product-price">@SharedLocalizer["Form.Prix"]</th>
                                                        <th class="product-remove">&nbsp;</th>
                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    @foreach (var item in Model)
                                                    {
                                                        total += item.CartVM.Book.BusinessPrice;
                                                        <tr class="woocommerce-cart-form__cart-item cart_item">
                                                            <td class="product-name" data-title="Product">
                                                                <div class="d-flex align-items-center">
                                                                    <a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")">
                                                                        <img src="@($"https://miplivrelstorage.blob.core.windows.net/bookscover/{@item.CartVM.Book.CoverPath}")" class="attachment-shop_thumbnail size-shop_thumbnail wp-post-image" alt="" style="height:180px;width:120px">
                                                                    </a>
                                                                    <div class="mx-3 m-w-200-lg-down">
                                                                        <a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")">@item.CartVM.Book.Title</a>
                                                                        <a asp-controller="Author" asp-action="GetAuthorDetails" asp-route-authorInfos="@($"{item.CartVM.Book.AuthorId}#{item.CartVM.Book.AuthorName.Replace(" ", "-")}")" class="text-gray-700 font-size-2 d-block" tabindex="0">@item.CartVM.Book.AuthorName</a>
                                                                    </div>
                                                                </div>
                                                            </td>

                                                            <td class="product-price" data-title="Price">
                                                                <span class="woocommerce-Price-amount amount">@item.CartVM.Book.BusinessPrice <span class="woocommerce-Price-currencySymbol">@SharedLocalizer["Book.Currency"]</span></span>
                                                            </td>
                                                            <td class="product-remove">
																<a value="@item.CartVM.Book.Id" data-BookPrice="@item.CartVM.Book.BusinessPrice" class="deleteRowCart remove arrow-cursor" aria-label="Remove this item">
                                                                    <i class="fas fa-trash"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </form>
                                    </div>

                                    <!-- Mobile Table -->
                                    <div class="woocommerce d-md-none mb-4">
                                        <form class="woocommerce-cart-form table-responsive" action="#" method="post">
                                            <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents">
                                                <thead>
                                                    <tr>
                                                        <th class="product-name text-center">@SharedLocalizer["Navbar.Livre"]</th>
                                                        @*<th class="product-price">@SharedLocalizer["Form.Prix"]</th>*@
                                                        @*<th class="product-remove">&nbsp;</th>*@
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model)
                                                    {
                                                        //total += item.CartVM.Book.Price;
                                                        <tr class="woocommerce-cart-form__cart-item cart_item">
                                                            <td class="product-name text-center" data-title="Product">
                                                                <div class=" align-items-center">
                                                                    <a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")">
                                                                        <img src="@($"https://miplivrelstorage.blob.core.windows.net/bookscover/{@item.CartVM.Book.CoverPath}")" class="attachment-shop_thumbnail size-shop_thumbnail wp-post-image" alt="" style="height:200px;width:150px">
                                                                    </a>
                                                                    <div class="my-3 m-w-200-lg-down">
                                                                        <a asp-action="GetBookDetails" asp-controller="Book" asp-route-BookInfos="@($"{item.CartVM.Book.Id}#{item.CartVM.Book.Title.Replace(" ", "-")}")">@item.CartVM.Book.Title</a>
                                                                        <a href="#" class="text-gray-700 font-size-2 d-block" tabindex="0">@item.CartVM.Book.AuthorName</a>
                                                                        <span class="font-size-2 d-block">@item.CartVM.Book.BusinessPrice <span class="woocommerce-Price-currencySymbol">@SharedLocalizer["Book.Currency"]</span></span>
                                                                    </div>
																	<a value="@item.CartVM.Book.Id" data-BookPrice="@item.CartVM.Book.BusinessPrice" class="deleteRowCart remove arrow-cursor" aria-label="Remove this item">
                                                                        <i class="font-size-4 fas fa-trash"></i>
                                                                    </a>
                                                                </div>
                                                            </td>
                                                                @*<td class="product-remove"></td>*@
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </form>
                                    </div>
                                </div>
                                <!-- .entry-content -->
                            </div>
                        </main>
                    </div>
                    <div id="secondary" class="sidebar cart-collaterals order-1" role="complementary">
                        <div id="cartAccordion" class="border border-gray-900 bg-white mb-5">
                            <div class="px-4d875 py-1 border" id="SubTotalDiv">
                                <table class="shop_table shop_table_responsive">
                                    <tbody>
                                        <tr class="order-total">
											<th>@SharedLocalizer["Cart.SubTotal"]</th>
											<td data-title="SubTotal" ><strong><label id="CartSubTotalId" class="woocommerce-Price-amount amount">@total @SharedLocalizer["Book.Currency"]</label></strong> </td>
                                        </tr>
										<tr class="order-total">
											<th>@SharedLocalizer["Cart.Tax"]</th>
											<td data-title="Total"><strong><label class="woocommerce-Price-amount amount">1 @SharedLocalizer["Book.Currency"]</label></strong> </td>
										</tr>
                                    </tbody>
                                </table>
                            </div>
							@{total++;}
							<div class="p-4d875 border">
								<table class="shop_table shop_table_responsive">
									<tbody>
										<tr class="order-total">
											<th>@SharedLocalizer["Cart.Total"]</th>
											<td data-title="Total"><strong><label id="CartTotalId" class="woocommerce-Price-amount amount">@total @SharedLocalizer["Book.Currency"]</label></strong> </td>
										</tr>
									</tbody>
								</table>
							</div>
                        </div>
                        <div class="wc-proceed-to-checkout">
                            @*<a href="#" id="CheckoutLink" class="checkout-button button alt wc-forward btn btn-dark btn-block rounded-0 py-4">@SharedLocalizer["Cart.Payment"]</a>*@
								<div class="card mb-2">
									<img src="~/img/paiement/postetn.png" class="card-img-top" alt="...">
									<div class="card-body d-flex justify-content-between align-items-center">
										<p class="card-text">@SharedLocalizer["PaiementType.PostOffice"]</p>
										<button id="Checkout_Post1" type="submit" class="btn btn-primary btn-sm @(Model.Count==0 ? "disabled" : "")">@SharedLocalizer["Cart.Payment"]</button>
									</div>
								</div>
								<div class="card">
									<img src="~/img/paiement/clic2pay.jpg" class="card-img-top" alt="...">
									<div class="card-body d-flex justify-content-between align-items-center">
										<p class="card-text">@SharedLocalizer["PaiementType.Bank"]</p>
										<button id="CheckoutLink" type="button" class="btn btn-primary btn-sm @(Model.Count==0 ? "disabled" : "")">@SharedLocalizer["Cart.Payment"]</button>
									</div>
								</div>
							</div>
                    </div>
                </div>
            }
        </div>
    </div>
}

<script type="text/javascript">
	
    $(document).ready(function () {
        $('a.deleteRowCart').click(function () {
            var bookId = $(this).attr("value");
            var _currentDiv = $(this).parent().parent();
            var _OldTotal = $('#CartTotalId')[0].innerHTML.split(" ")[0];
			var _OldSubTotal = $('#CartSubTotalId')[0].innerHTML.split(" ")[0];
            var _OldCount = $('#CartCountId')[0].innerHTML;
            var _bookPrice = $(this).attr("data-BookPrice");
            //debugger
            $.ajax({
                method: "delete",
                url: "/Book/DeleteBookFromCart",
                data: "BookId=" + JSON.stringify(bookId),
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                async: false,
                success: function () {
                    var _NewTotal = parseFloat(_OldTotal) - parseFloat(_bookPrice);
					var _NewSubTotal = parseFloat(_OldSubTotal) - parseFloat(_bookPrice);
                    var _NewCount = parseFloat(_OldCount) - 1;
					
					if (parseFloat(_NewSubTotal) == 0) {
						$("#CartTotalId").empty();
						$("#CartTotalId").append("0 " + '@SharedLocalizer["Book.Currency"]');
						$("#SubTotalDiv").remove();
						$('#Checkout_Post1').prop('disabled', true);
						$('#CheckoutLink').prop('disabled', true);
					}else{
						$("#CartTotalId").empty();
						$("#CartTotalId").append(_NewTotal + " " + '@SharedLocalizer["Book.Currency"]');
						$("#CartSubTotalId").empty();
						$("#CartSubTotalId").append(_NewSubTotal + " " + '@SharedLocalizer["Book.Currency"]');
					}
                    //debugger

                    $("#CartCountId").empty();
                    $("#CartCountId").append(_NewCount);
					$("#totalCount").text(_NewCount);
					$("#totalCountMobile").text(_NewCount);
                    _currentDiv.remove();


					
                    },
                    error: function (response, textStatus) {
                    //debugger
                    alert(textStatus);
                    }
                    });
        });

        //$("button.btn-outline-dark").click(function (e) {r
        //    e.preventDefault();
        //    window.location.pathname = '/MyAccount/Index';
        //});

        $("#CheckoutLink").click(function (e) {
            e.preventDefault();
            ////debugger
            $.ajax({
                method: "Get",
                url: "@Url.Action("ClickToPayRegister", "MyAccount")",
                success: function (response) {
                    //debugger
                    //if (JSON.parse(response.data).formUrl)
                    //window.open(response.data.url,"_blank");
					window.location.href = response.data.url;
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    $(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
                        $(".md-toast-error").slideUp(500);
                    });
                }
            });
        });
		 $("#Checkout_Post1").click(function (e) {
        alert("test")
        $.ajax({
            method: "Get",
            url: "/MyAccount/MPGSCreateSession",
            success: function (response) {
                //alert(response)
                //alert(response.data)
                //alert(response["result"])
                //alert(JSON.parse(response)["merchant"])
                //var resp = JSON.parse(response);
                var responseobj = JSON.parse(response["result"])["session"];
               // var merchantId = response["merchantId"];
                var sessionId= responseobj["id"];
					Checkout.configure({
						session: {
							id: sessionId
						}
					})
					Checkout.showPaymentPage();
            },
            error: function (jqXhr, textStatus, errorThrown) {
                $(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
                    $(".md-toast-error").slideUp(500);
                });
            }
        });
    });
    });
</script>
