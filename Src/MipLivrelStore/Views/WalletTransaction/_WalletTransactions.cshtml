@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.AspNetCore.Localization
@inject IStringLocalizer<SharedResource> SharedLocalizer


@using DDD.Application.ViewModels;
@using MipLivrelStore;
@model List<WalletTransactionViewModel>
<style>
    .btn-xl {
        padding: 10px 20px;
        font-size: 20px;
        border-radius: 10px;
    }

    .card {
        flex-direction: row;
        height: fit-content;
    }

    .card img {
        width: 50px;
        height: 50px;
        border-right: 1px solid rgba(0, 0, 0, 0.125);
    }

    .card-body {
        padding-bottom: 0;
        padding-top: 0;
    }

    .right{
        float:right;
    }

    .right-header {
        float: right;
        padding: 1.6rem 3rem;
    }

    .reduced-padding{
        padding: 0rem 2rem;
    }

    /* Accordion css */
    .accordion {
        /*background-color: #eee;*/
        background-color: white;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
    }

        .active-accordion, .accordion:hover {
            /*background-color: #ccc;*/
            background-color: white;
        }

        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: left;
            margin-right: 1rem;
        }

    .active-accordion:after {
        content: "\2212";
    }

    .panel {
        padding: 0 18px;
        background-color: #eee;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
    }

</style>
@{
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    var selectedCulture = requestCulture.RequestCulture.Culture;
    var total = 0.0;
    <div class="site-content overflow-hidden" id="content">
        <div class="container">
            <header class="entry-header space-top-2 space-bottom-1">
                <label class="entry-title font-size-5">
                    @SharedLocalizer["Index.MyWalletTransactions"]
                </label>
            </header>
            
            
                <header>
                    <label class="entry-title font-size-2">
                        @SharedLocalizer["WalletTransaction.Refill"]
                    </label>
                </header>
                <div class="row pb-8">
                    <div id="primary" class="content-area">
                        <div id="cartAccordion" class="border border-gray-900 bg-white mb-5">
                            <div class="px-4d875 py-1 border" id="SubTotalDiv">
                                <header>
                                    <label class="font-size-2">@SharedLocalizer["WalletTransaction.RefillPhrase"]</label>
                                </header>

                                <input id="amount_input"
                                       type="text" oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                                       placeholder="@SharedLocalizer["WalletTransaction.RefillInstruction"]" />

                                <header>
                                    <label class="font-size-1">@SharedLocalizer["WalletTransaction.RefillInstruction"]</label>
                                </header>

                            </div>
                            @{
                                total++;
                            }

                        </div>
                        <div class="wc-proceed-to-checkout">
                            @*<a href="#" id="CheckoutLink" class="checkout-button button alt wc-forward btn btn-dark btn-block rounded-0 py-4">@SharedLocalizer["Cart.Payment"]</a>*@
                            <div class="card mb-2">
                                <img src="~/img/paiement/postetn.png" class="card-img-top" alt="...">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <p class="card-text">@SharedLocalizer["PaiementType.PostOffice"]</p>
                                    <button id="Checkout_Post1" type="submit" class="btn btn-primary btn-sm ">@SharedLocalizer["WalletTransaction.Refill"]</button>
                                </div>
                            </div>
                            <div class="card">
                                <img src="~/img/paiement/clic2pay.jpg" class="card-img-top" alt="...">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <p class="card-text">@SharedLocalizer["PaiementType.Bank"]</p>
                                    <button id="CheckoutLink" type="button" class="btn btn-primary btn-sm ">@SharedLocalizer["WalletTransaction.Refill"]</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            @if (@Model.Count == 0)
            {
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-md-12 text-center">
                            <img src="~/Template/Image/NoResultFound.png" class="resultNotFound" alt="No Result Found" />
                            <div class="mb-4 lead">@SharedLocalizer["SearchResult.NoResultFound"]</div>
                            <p>@SharedLocalizer["SearchResult.NoResultFoundText"]</p>
                            <a asp-controller="MyAccount" asp-action="Index" class="MyAccountGoBack btn btn-dark rounded-0 text-white">@SharedLocalizer["Index.GoBack"]</a>
                        </div>
                    </div>
                </div>
            } else{
                <div class="row pb-8">
                    <div id="primary" class="content-area">
                        <main id="main" class="site-main ">
                            <div class="page type-page status-publish hentry">
                                <!-- .entry-header -->
                                <div class="entry-content">
                                    <div class="woocommerce d-none d-md-flex">
                                        <div class="woocommerce-cart-form table-responsive">
                                            <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents">
                                                <thead>
                                                    <tr>
                                                        <th class="product-name">@SharedLocalizer["WalletTransaction.Type"]</th>
                                                        <th class="product-remove">&nbsp;</th>
                                                        <th class="product-price right-header">@SharedLocalizer["WalletTransaction.Date"]</th>

                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    @foreach (var item in Model)
                                                    {
                                                        <tr>
                                                            <td colspan="3" class="reduced-padding">
                                                                <button class="accordion">
                                                                    @{
                                                                        var label = item.Invoice?.Book != null ? @SharedLocalizer["Book.Purshase"] :
                                                                        (@item.Type == DDD.Domain.Models.Enums.WalletTransactionTypeEnum.Refill ?
                                                                            @SharedLocalizer["WalletTransaction.Refilled"] : @SharedLocalizer["WalletTransaction.Withdrawed"]);
                                                                    }
                                                                    @label
                                                                    <span class="right">@DateTime.Parse(item.CreatedAt).ToString("dd/MM/yyyy") </span></button>
                                                                <div class="panel">
                                                                    <div class="woocommerce-cart-form__cart-item cart_item">

                                                                        <div class="product-price" data-title="Price">
                                                                            <span class="woocommerce-Price-amount amount">Prix : @item.Amount <span class="woocommerce-Price-currencySymbol">@SharedLocalizer["Book.Currency"]</span></span>
                                                                        </div>
                                                                        <div class="product-price" data-title="Price">
                                                                            <span class="woocommerce-Price-amount amount"> Droit de timbre : 0 <span class="woocommerce-Price-currencySymbol">@SharedLocalizer["Book.Currency"]</span></span>
                                                                        </div>
                                                                        <div class="product-price border-top" data-title="Price">
                                                                            <span class="woocommerce-Price-amount amount">TOTAL : @item.Amount <span class="woocommerce-Price-currencySymbol">@SharedLocalizer["Book.Currency"]</span></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                            </td>
                                                            
                                                        </tr>

                                                    }
                                                </tbody>
                                            </table>
                                            <!-- <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents">
                                                        <thead>
                                                            <tr>
                                                                <th class="product-name">@SharedLocalizer["WalletTransaction.Type"]</th>
                                                                <th class="product-remove">&nbsp;</th>
                                                                <th class="product-price">@SharedLocalizer["WalletTransaction.Date"]</th>

                                                            </tr>
                                                        </thead>

                                                        <tbody>
                                            @foreach (var item in Model)
                                            {

                                                                                    <tr class="woocommerce-cart-form__cart-item cart_item">



                                                                                        <td class="product-name" data-title="Product">
                                                                                            <div class="d-flex align-items-center">
                                                                                                <div class="mx-3 m-w-200-lg-down">
                                                                @{
                                                                    var label = item.Invoice?.Book != null ? @SharedLocalizer["Book.Purshase"] :
                                                                    (@item.Type == DDD.Domain.Models.Enums.WalletTransactionTypeEnum.Refill ?
                                                                        @SharedLocalizer["WalletTransaction.Refilled"] : @SharedLocalizer["WalletTransaction.Withdrawed"]);
                                                                }
                                                                @label
                                                                        <span class="right">@DateTime.Parse(item.CreatedAt).ToString("dd/MM/yyyy") </span>
                                                                                                </div>
                                                                                            </div>
                                                                                        </td>
                                                                                        

                                                                                    </tr>


                                            }
                                                        </tbody>
                                                    </table> -->
                                        </div>
                                    </div>

                                    <!-- Mobile Table -->

                                    <div class="woocommerce d-md-none mb-4">
                                        <form class="woocommerce-cart-form table-responsive" action="#" method="post">
                                            <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents">
                                                <thead>
                                                    <tr>
                                                        <th class="product-name text-center">@SharedLocalizer["Navbar.Livre"]</th>
                                                        @*<th class="product-price">@SharedLocalizer["Form.Prix"]</th>*@
                                                        @*<th class="product-remove">&nbsp;</th>*@
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model)
                                                    {
                                                        <tr class="woocommerce-cart-form__cart-item cart_item">



                                                            <td class="product-name" data-title="Product">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="mx-3 m-w-200-lg-down">
                                                                        @{
                                                                            var label = item.Invoice?.Book != null ? @SharedLocalizer["Book.Purshase"] :
                                                                            (@item.Type == DDD.Domain.Models.Enums.WalletTransactionTypeEnum.Refill ?
                                                                            @SharedLocalizer["WalletTransaction.Refilled"] : @SharedLocalizer["WalletTransaction.Withdrawed"]);
                                                                        }
                                                                        @label
                                                                        <span class="right">@DateTime.Parse(item.CreatedAt).ToString("dd/MM/yyyy") </span>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td></td>
                                                            <td class="product-price" data-title="Price">
                                                                <span class="woocommerce-Price-amount amount">@DateTime.Parse(item.CreatedAt).ToString("dd/MM/yyyy") </span>
                                                            </td>

                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </form>
                                    </div>
                                </div>
                                <!-- .entry-content -->
                            </div>
                        </main>
                    </div>

                </div>
            }
        </div>
    </div>
}

<script type="text/javascript">

    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
            this.classList.toggle("active-accordion");
            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
    }

    $(document).ready(function () {
        
        $("#CheckoutLink").click(function (e) {
            e.preventDefault();
            debugger;
            var amount = $('#amount_input').val();
            if(amount ===''){
                alert('No amount input found');
                return false;
            }
            $.ajax({
                method: "Get",
                url: "@Url.Action("ClickToPayRegister", "WalletTransaction")",
                data: {'amount':amount * 1000},
                success: function (response) {
                    window.location.href = response.data.url;
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    $(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
                        $(".md-toast-error").slideUp(500);
                    });
                }
            });
        });
        $("#Checkout_Post1").click(function (e) {
            //alert("test")
            debugger;
            var amount = $('#amount_input').val();
            if (amount === '') {
                alert('No amount input found');
                return false;
            }
            $.ajax({
                method: "Get",
                url: "@Url.Action("MPGSCreateSession", "WalletTransaction")",
                data: { 'amount': amount },
                success: function (response) {
                    var responseobj = JSON.parse(response["result"])["session"];
                    // var merchantId = response["merchantId"];
                    var sessionId = responseobj["id"];
                    Checkout.configure({
                        session: {
                            id: sessionId
                        }
                    })
                    Checkout.showPaymentPage();
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    $(".md-toast-error").fadeTo(2000, 500).slideUp(500, function () {
                        $(".md-toast-error").slideUp(500);
                    });
                }
            });
        });
    });
</script>
